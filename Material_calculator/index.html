<!DOCTYPE html>
<html>
<head>
	<title>Material Calculator</title>
	<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="style.css">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<script src="http://code.jquery.com/jquery-1.12.0.js"></script>

</head>

<body>
	<div id="container">
		<div id="screen" class="ripplelink noselect">
			<div id="screenNum">777</div><br style="clear:both;">
			<div id="lowerNum"></div>
		</div>
		<!-- <br>
		-->
		<div id="keyPane">
			<div id="leftPane">
				<div class='keyNum ripplelink noselect' onclick="click_num(this);">7</div>
				<div class='keyNum ripplelink noselect' onclick="click_num(this);">8</div>
				<div class='keyNum ripplelink noselect' onclick="click_num(this);">9</div>
				<br style="clear:both;">

				<div class='keyNum ripplelink noselect' onclick="click_num(this);">4</div>
				<div class='keyNum ripplelink noselect' onclick="click_num(this);">5</div>
				<div class='keyNum ripplelink noselect' onclick="click_num(this);">6</div>
				<br style="clear:both;">

				<div class='keyNum ripplelink noselect' onclick="click_num(this);">1</div>
				<div class='keyNum ripplelink noselect' onclick="click_num(this);">2</div>
				<div class='keyNum ripplelink noselect' onclick="click_num(this);">3</div>
				<br style="clear:both;">

				<div class='keyNum ripplelink noselect' onclick="click_num(this);">.</div>
				<div class='keyNum ripplelink noselect' onclick="click_num(this);">0</div>
				<div class='keyNum ripplelink noselect' onclick="click_sign(this);">=</div>
				<!-- END OF KEYPANE -->
			</div>

			<div id="rightPane">
				<span class='keySign ripplelink noselect' style='font-size:17pt;' onclick="click_sign(this);">DEL</span>
				<br>
				<span class='keySign ripplelink noselect' onclick="click_sign(this);">÷</span>
				<br>
				<span class='keySign ripplelink noselect' onclick="click_sign(this);">x</span>
				<br>
				<span class='keySign ripplelink noselect' onclick="click_sign(this);">-</span>
				<br>
				<span class='keySign ripplelink noselect' onclick="click_sign(this);">+</span>
				<!-- END OF KEYSIGN -->
			</div>
		</div>

		<!-- end of container -->
	</div>

	<script type="text/javascript">
	var screen_num = document.getElementById('screenNum');
	var cur_num_str;
	var keySign_pressed = false;
	var KeyNum_pressed = false;
	// list to store array of input numbers
	var inputList = [];


	function parse_click_num(clickNum){
		if (clickNum.length >= 7){
			clickNum = clickNum.split('</span>')[1];
		}
	
		return clickNum;
	}

	function click_num(v){
		if(KeyNum_pressed === false || cur_num_str === 0){
			screen_num.innerHTML = parse_click_num(v.innerHTML);
			cur_num_str = screen_num.innerHTML;
			KeyNum_pressed = true;
		}else{
			// input num should not be too large
			if( parse_click_num(document.getElementById('screenNum').innerHTML).length < 4 && cur_num_str !== 0){
				// input multiple digits
				cur_num_str += parse_click_num(v.innerHTML);
				screen_num.innerHTML = cur_num_str;
				
				console.log('cur num:' + cur_num_str + '\nhtml:' + parse_click_num(v.innerHTML) + '\n inner:' + v.innerHTML);
			}
			else{
				alert('Too many digits (#`Д´)>')
			}	
		}
		// add digits to input list
		inputList.push(cur_num_str);
		document.getElementById('lowerNum').innerHTML = get_formula(inputList);
		
		keySign_pressed = false;
	// end of click_num
	}

	

	function add_prarentheses(curList){
		for(var i = curList.length; i > 0; i--){
			if(curList[i] === '+' || curList[i] === '-' ){
				curList.splice(0,0,'(');
				curList.splice(i+3,0,')');
				// console.log('curList:' + curList.join(''));
				return curList;	
			}
		}

		return curList;
	}


	function get_formula(list){
		var curList = [];

		for(var i = 0; i < list.length; i++){

			if(list[i] === 'x' || list[i] === '÷' ){
				curList = add_prarentheses(curList);
			}

			curList.push(list[i]);
			
		}

		// make it string
		// repace ÷ as / and x as *
		var curStr = curList.join('');
		curStr = curStr.split('x').join('*');
		curStr = curStr.split('÷').join('/');
		console.log(curStr);
		return curStr;
	}

	function get_result(list){
		// list must be even
		var sum = 0.0;
		for(var i = 0; i < list.length; i++){
			// every odd slot is operator 
			if(i%2 === 1){
				if(list[i] === '+'){
					sum += parseFloat(list[i+1]);
				}else if(list[i] === '-'){
					sum -= parseFloat(list[i+1]);
				}
				else if(list[i] === 'x'){
					sum *= parseFloat(list[i+1]);
				}else if(list[i] === '-'){
					sum /= parseFloat(list[i+1]);
				}

				i = i+1;
			}
		}

		return sum;
	}


	function click_sign(v){
		if(!keySign_pressed){
			var sign = parse_click_num(v.innerHTML);

			console.log('clicked:'+ parse_click_num(v.innerHTML));
			if(sign === 'DEL'){
				if(cur_num_str.length > 1){
					cur_num_str = cur_num_str.slice(0,-1);
					console.log(cur_num_str);
					// why cant I use screen_num here?
					document.getElementById('screenNum').innerHTML = cur_num_str;
				}
				else{
					cur_num_str = 0;
					document.getElementById('screenNum').innerHTML = cur_num_str;
				}
			}else if(sign === '+' || sign === '-' || sign === 'x' || sign === '÷' ){
				inputList.push(cur_num_str);
				inputList.push(sign);
				cur_num_str = '';
				document.getElementById('screenNum').innerHTML = cur_num_str;
				document.getElementById('lowerNum').innerHTML = get_formula(inputList);
			}
			else if(sign === '='){
				if(inputList.length/2 === 1){
				// show the result to larger num
				document.getElementById('screenNum').innerHTML = get_result(inputList);
				document.getElementById('lowerNum').innerHTML += ' = ' + get_result(inputList);
				}else{
					alert('Not enough numbers for operators.')
				}
			}
			else{
				alert('Out of nothing comes nothing (#`Д´)>');
			}
			// disable sign input unless 
			keySign_pressed = true;
			// enable multi digits input 
			KeyNum_pressed = false;
		}
		else{
			console.log('keySign_pressed is true');
		}
	}


	/*jQuery*/

		$(function(){
			var ink, d, x, y;
			$(".ripplelink").click(function(e){
		    if($(this).find(".ink").length === 0){
		        $(this).prepend("<span class='ink'></span>");
		    }
		         
		    ink = $(this).find(".ink");
		    ink.removeClass("animate");
		     
		    if(!ink.height() && !ink.width()){
		        d = Math.max($(this).outerWidth(), $(this).outerHeight());
		        ink.css({height: d, width: d});
		    }
		     
		    // x = e.pageX - $(this).offset().left - ink.width()/2;
		    // y = e.pageY - $(this).offset().top - ink.height()/2;

		    // center the effect
		    x = e.pageX - $(this).left - ink.width()/2;
		    y = e.pageY - $(this).top - ink.height()/2;
		     
		    ink.css({top: y+'px', left: x+'px'}).addClass("animate");
		});
	});
	// end of js
	</script>

</body>
</html>